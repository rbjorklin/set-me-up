# See 'man zshbuiltins' and https://stackoverflow.com/a/30840986
# adds completion for git etc.
autoload -Uz compinit && compinit

export GOPATH=${HOME}/go
export PATH="${HOME}/.local/bin:${HOME}/.cargo/bin:${KREW_ROOT:-$HOME/.krew}/bin:${GOPATH}/bin:${PATH}"

# Adapt autosuggest color to Solarized
export ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=11"

export CASE_SENSITIVE="true"
export WORDCHARS='*?_[]~=&;!#$%^(){}'

# makes ctrl + u behave the same as bash (emacs)
bindkey "^u" backward-kill-line 

#ZSH customizations
setopt HIST_FIND_NO_DUPS
setopt HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_DUPS
setopt HIST_IGNORE_SPACE
unsetopt SHARE_HISTORY
setopt EXTENDED_HISTORY
export HISTFILE=~/.zsh_history
export SAVEHIST=100000 # Number of commands that are stored in the zsh history file
export HISTSIZE=100000 # Number of commands that are loaded into memory from the history file
export WORDCHARS=''
# Load last used in a new terminal
export KUBECONFIG=$(for f in $(ls -t ~/.kube/configs) ; do ls ~/.kube/configs/${f} ; break ; done)
export KUBECONFIGS=$(for f in $(ls -t ~/.kube/configs) ; do ls ~/.kube/configs/${f} ; done | tr "\n" : | sed 's/:$//g')

# If this works well over time report back to: https://github.com/ahmetb/kubectx/issues/12
function kctx() {
    previous=$(kubectl ctx --current)
    kubeconfig_bak="$(echo ${KUBECONFIG} | cut -d : -f 1)"
    export KUBECONFIG="${KUBECONFIGS}"
    kubectl ctx "$@"
    if [[ $? -eq 0 ]] ; then
        # Capture the newly set context
        ctx=$(kubectl ctx --current)
        # kubectl ctx updates 'current-context' in the first file, reset it
        first_kubeconfig=$(echo ${KUBECONFIGS} | cut -d : -f 1)
        yq -i '.current-context = .contexts[0].name' ${first_kubeconfig}
        # My context files do not have the user name in them so split it out
        ctx_split=$(echo ${ctx} | cut -d @ -f 2)
        # Find the new file and set it
        ctx_file=$(find ~/.kube/configs -mindepth 1 -iname "${ctx_split}.yaml")
        yq -i '.current-context = .contexts[0].name' ${ctx_file}
        export KUBECONFIG="${ctx_file}"
        # kubectl ctx loses track of which the previous namespace was when juggling files
        echo "${previous}" > ~/.kube/kubectx
    else
        export KUBECONFIG="${kubeconfig_bak}"
    fi
}

function kubeconfig() {
    local context=$(echo $1 | base64 -d | yq '.contexts[0].name')
    echo $1 | base64 -d > ~/.kube/configs/${context}.yaml
    echo $context
}

# Make vim open files in tabs by default
alias vim="vim -p"
alias urldecode='python3 -c "import sys, urllib.parse as ul; print(\"\n\" + ul.unquote_plus(sys.argv[1]))"'
alias urlencode='python3 -c "import sys, urllib.parse as ul; print(\"\n\" + ul.quote_plus(sys.argv[1]))"'
alias k="kubectl"
alias kc="kubectl create --dry-run=client -o yaml"
alias kns="kubectl ns"
alias reset-gpaste="systemctl --user restart org.gnome.GPaste.service"

# Variables
export VISUAL="vim"
export EDITOR="vim"

# LazyLoad the kubectl completion code for zsh into the current shell
function kubectl() {
    if ! type __start_kubectl &> /dev/null ; then
        source <(command kubectl completion zsh)
    fi

    command kubectl "$@"
}

# Put machine specific stuff here
if [[ -f ~/.zshrc.custom ]] ; then
    source ~/.zshrc.custom
fi

source ~/.zsh/zsh-autosuggestions/zsh-autosuggestions.zsh

# zsh-histdb
source ~/.zsh/zsh-histdb/sqlite-history.zsh
autoload -Uz add-zsh-hook
source ~/.zsh/zsh-histdb/histdb-interactive.zsh

# zsh-histdb-skim
source ~/.zsh/zsh-histdb-skim/zsh-histdb-skim.zsh
bindkey '^r' histdb-skim-widget

_zsh_autosuggest_strategy_histdb_top_here_and_now() {
    local query="
WITH
  interim_table (command) AS
(
  SELECT
    commands.argv
  FROM
    history
  LEFT JOIN
    commands
  ON
    history.command_id = commands.id
  WHERE
    commands.argv
  LIKE
    '$(sql_escape $1)%'
  GROUP BY
    commands.argv,
    history.session,
    history.start_time
  ORDER BY
    history.session = '$(sql_escape $HISTDB_SESSION)' DESC,
    history.start_time DESC
)
SELECT DISTINCT
  command
FROM
  interim_table
LIMIT 1"
    suggestion=$(_histdb_query "$query")
}

ZSH_AUTOSUGGEST_STRATEGY=histdb_top_here_and_now

# opam configuration
test -r /home/rbjorklin/.opam/opam-init/init.zsh && . /home/rbjorklin/.opam/opam-init/init.zsh > /dev/null 2> /dev/null || true
eval "$(starship init zsh)"
